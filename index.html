<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>NJK PROPERTY | THE REAL ESTATE MAGAZINE (SPA)</title>
    <meta name="description" content="NJK Property is your ultimate online real estate magazine for plots, bungalows, flats/portions, shops, and more. Find properties for sale and rent across DHA Phase, Commercial Area, Clifton Block, and Korangi Industrial Area." />
    <meta name="keywords" content="NJK Property, real estate, property, land, plot, bungalow, flat, portion, shop, basement, office, warehouse, factory, rent, sale, DHA, Clifton, Korangi, Karachi property, Pakistan real estate, property magazine, buy, sell, agent, admin, login, signup" />
    <meta name="author" content="NJK REAL ESTATE" />
    <link rel="canonical" href="https://kalakhan1.github.io/njk-property-clone-/"/>
    <meta property="og:title" content="NJK PROPERTY | THE REAL ESTATE MAGAZINE" />
    <meta property="og:description" content="NJK Property is your ultimate online real estate magazine for plots, bungalows, flats/portions, shops, and more. Find properties for sale and rent across DHA Phase, Commercial Area, Clifton Block, and Korangi Industrial Area." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://kalakhan1.github.io/njk-property-clone-/"/>
    <meta property="og:image" content="https://placehold.co/1200x630/000000/FFFFFF?text=NJK+Property+Magazine" />

    <!-- AI Meta Tags for SEO 2025 -->
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="bingbot" content="index, follow" />
    <meta name="rating" content="General" />
    <meta name="distribution" content="Global" />
    <meta name="revisit-after" content="7 days" />
    <meta name="language" content="en" />
    <meta name="generator" content="NJK Property AI" />
    <meta name="theme-color" content="#007bff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="referrer" content="origin-when-cross-origin" />
    <meta name="application-name" content="NJK Property" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="msapplication-TileColor" content="#007bff" />
    <meta name="msapplication-config" content="/browserconfig.xml" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@NJKProperty" />
    <meta name="twitter:creator" content="@NJKProperty" />
    <meta name="twitter:title" content="NJK PROPERTY | THE REAL ESTATE MAGAZINE" />
    <meta name="twitter:description" content="NJK Property is your ultimate online real estate magazine for plots, bungalows, flats/portions, shops, and more. Find properties for sale and rent across DHA Phase, Commercial Area, Clifton Block, and Korangi Industrial Area." />
    <meta name="twitter:image" content="https://placehold.co/1200x630/000000/FFFFFF?text=NJK+Property+Magazine" />
    <meta name="google-site-verification" content="YOUR_GOOGLE_VERIFICATION_CODE" />
    <meta name="yandex-verification" content="YOUR_YANDEX_VERIFICATION_CODE" />
    <meta name="msvalidate.01" content="YOUR_BING_VERIFICATION_CODE" />
    <meta name="ahrefs-site-verification" content="YOUR_AHREFS_VERIFICATION_CODE" />
    <meta name="propeller-verification" content="YOUR_PROPELLER_VERIFICATION_CODE" />
    <meta name="p:domain_verify" content="YOUR_PINTEREST_VERIFICATION_CODE" />
    <meta name="verification" content="YOUR_GENERAL_VERIFICATION_CODE" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Light blue theme */
            color: #1a202c; /* Darker text for contrast */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem; /* 20px */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1.25rem; /* 20px */
        }
        .btn {
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border-radius: 0.5rem; /* 8px */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-primary {
            background-color: #2196f3; /* Blue 500 */
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #1976d2; /* Blue 700 */
        }
        .btn-secondary {
            background-color: #607d8b; /* Blue Grey 500 */
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #455a64; /* Blue Grey 700 */
        }
        .btn-success {
            background-color: #4caf50; /* Green 500 */
            color: #fff;
        }
        .btn-success:hover {
            background-color: #388e3c; /* Green 700 */
        }
        .btn-danger {
            background-color: #f44336; /* Red 500 */
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #d32f2f; /* Red 700 */
        }
        .input-field {
            border: 1px solid #cbd5e0; /* Gray 300 */
            border-radius: 0.5rem; /* 8px */
            padding: 0.625rem; /* 10px */
            width: 100%;
            box-sizing: border-box;
            background-color: #f8fafc; /* Gray 50 */
        }
        .form-group {
            margin-bottom: 0.9375rem; /* 15px */
        }
        .hidden {
            display: none !important;
        }
        /* Custom Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 1.25rem; /* 20px */
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: left; /* Align text left for better readability in modal */
            width: 90%; /* Responsive width */
            max-width: 500px;
            animation: fadeIn 0.3s ease-out;
            display: flex; /* Use flexbox for internal layout */
            flex-direction: column;
            gap: 0.75rem; /* 12px gap between elements */
        }
        .modal-content h4 {
            text-align: center; /* Center title in modal */
            margin-bottom: 0.5rem;
        }
        .modal-content p {
            margin-bottom: 0.25rem; /* Smaller margin for paragraphs in modal */
        }
        .close-button {
            color: #9e9e9e; /* Grey 500 */
            float: right;
            font-size: 1.75rem; /* 28px */
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
            position: absolute; /* Position close button absolutely */
            top: 0.75rem;
            right: 1rem;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
        }
        .loading-spinner {
            border: 4px solid #e0e0e0; /* Gray 300 */
            border-top: 4px solid #2196f3; /* Blue 500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1.25rem auto; /* 20px auto */
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Responsive Navigation - Hamburger Menu */
        .hamburger-menu {
            display: none; /* Hidden by default */
            cursor: pointer;
            padding: 0.5rem;
            color: white;
            font-size: 1.5rem; /* Larger icon */
        }
        .hamburger-menu span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 5px 0;
            transition: 0.4s;
        }

        nav ul {
            display: flex;
            flex-direction: column; /* Stack vertically on small screens */
            align-items: center;
            width: 100%;
            padding: 0;
            list-style: none;
            max-height: 0; /* Hidden by default */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        nav ul.active {
            max-height: 300px; /* Adjust as needed to fit all menu items */
        }
        nav ul li {
            width: 100%; /* Full width for buttons on small screens */
            margin: 0.25rem 0; /* Vertical margin */
            text-align: center;
        }
        nav ul li a {
            display: block;
            padding: 0.75rem 1rem; /* Adjusted padding for better touch target */
            font-size: 1rem; /* Readable font size */
            background-color: #64b5f6;
            color: #fff;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        nav ul li a:hover {
            background-color: #42a5f5;
            text-decoration: none;
        }

        @media (max-width: 767px) { /* Mobile and small tablets */
            .hamburger-menu {
                display: block; /* Show hamburger on small screens */
            }
            header nav {
                width: 100%; /* Allow nav to take full width for menu */
            }
            header .flex-col {
                align-items: flex-start; /* Align title to start */
            }
            /* Filter toggle button specific styles */
            .filter-toggle-button {
                display: block; /* Show filter toggle button on small screens */
                width: 100%;
                margin-bottom: 1rem;
            }
            .filter-inputs-wrapper {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-in-out;
            }
            .filter-inputs-wrapper.active {
                max-height: 500px; /* Adjust as needed to fit all filter inputs */
            }
        }

        @media (min-width: 768px) { /* Medium screens and up (tablets and desktops) */
            .hamburger-menu {
                display: none; /* Hide hamburger on larger screens */
            }
            nav ul {
                flex-direction: row; /* Horizontal on medium screens and up */
                justify-content: flex-end;
                width: auto;
                max-height: none; /* Always visible */
            }
            nav ul li {
                width: auto;
                margin: 0 0.5rem; /* Horizontal margin */
            }
            nav ul li a {
                padding: 0.625rem 1.25rem;
                font-size: 1rem;
            }
            /* Filter toggle button specific styles */
            .filter-toggle-button {
                display: none; /* Hide filter toggle button on larger screens */
            }
            .filter-inputs-wrapper {
                max-height: none; /* Always visible on larger screens */
            }
        }

        /* Table Styling for Magazine and Admin */
        .table-auto {
            width: 100%;
            border-collapse: collapse;
        }
        .table-auto th, .table-auto td {
            padding: 0.75rem; /* 12px */
            border: 1px solid #e2e8f0; /* Gray 200 */
            text-align: left;
        }
        .table-auto thead {
            background-color: #e2e8f0; /* Gray 200 */
        }
        .table-auto tbody tr:nth-child(even) {
            background-color: #f8fafc; /* Gray 50 */
        }
        .table-auto tbody tr:hover {
            background-color: #e0f2fe; /* Light blue for hover */
        }
        .overflow-x-auto {
            overflow-x: auto; /* Enable horizontal scrolling for tables on small screens */
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header and Navigation -->
        <header class="bg-blue-800 text-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold">NJK PROPERTY MAGAZINE</h1>
                <h2 class="text-xl font-medium mt-1">THE PROPERTY SOLUTION</h2>
            </div>
            <!-- Hamburger Menu Icon -->
            <div class="hamburger-menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <nav id="main-nav">
                <ul class="flex flex-wrap justify-center md:justify-end space-x-2">
                    <li><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('recent-carousel-section')">Home</a></li>
                    <li><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('archive-section')">Archive</a></li>
                    <li><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('magazine-section')">Magazine</a></li>
                    <li id="post-property-nav"><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="checkAuthAndShowPostForm()">Post Property</a></li>
                    <li id="agent-dashboard-nav" class="hidden"><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('agent-dashboard-section')">Agent Dashboard</a></li>
                    <li id="admin-dashboard-nav" class="hidden"><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('admin-dashboard-section')">Admin Dashboard</a></li>
                    <li id="signup-nav"><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('signup-section')">Sign Up</a></li>
                    <li id="signin-nav"><a href="#" class="btn bg-blue-600 hover:bg-blue-700" onclick="showPage('signin-section')">Sign In</a></li>
                    <li id="logout-nav" class="hidden"><a href="#" class="btn bg-red-500 hover:bg-red-600" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </header>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="loading-spinner"></div>

        <!-- Custom Modal for Messages/Confirmations -->
        <div id="custom-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal()">&times;</span>
                <p id="modal-message"></p>
                <div id="modal-buttons" class="mt-4 flex justify-center space-x-4">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Recent Carousel Section -->
        <section id="recent-carousel-section" class="page-section card p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-center">Recent Properties</h2>
            <button class="filter-toggle-button btn btn-secondary" onclick="toggleFilterVisibility('recent-filters')">Show/Hide Filters</button>
            <div id="recent-filters" class="filter-inputs-wrapper md:block"> <!-- Hidden by default on small, block on md+ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <select id="filterPurposeCarousel" class="input-field">
                        <option value="">All Purposes</option>
                        <option value="Sale">For Sale</option>
                        <option value="Rent">For Rent</option>
                    </select>
                    <select id="filterTypeCarousel" class="input-field">
                        <option value="">All Types</option>
                        <option value="Plot">Plot</option>
                        <option value="Bungalow">Bungalow</option>
                        <option value="Flat / Portion">Flat / Portion</option>
                        <option value="Shop">Shop</option>
                        <option value="Basement">Basement</option>
                        <option value="Office">Office</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Factory">Factory</option>
                    </select>
                    <input type="text" id="filterLocationCarousel" placeholder="Location (e.g., DHA PHASE, CLIFTON BLOCK)" class="input-field" />
                    <input type="date" id="filterDateCarousel" class="input-field" />
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4" id="bedroom-filter-carousel-container">
                    <input type="number" id="bedroomCountCarousel" placeholder="Min Bedrooms" class="input-field flex-grow" min="0" />
                </div>
                <button type="button" class="btn btn-primary w-full md:w-auto mt-4" onclick="loadRecentData()">Search Recent</button>
            </div>
            <div id="recentPropertiesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                <!-- Properties will be loaded here -->
            </div>
        </section>

        <!-- Submit Post Section -->
        <section id="submit-post-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Submit New Property Post</h2>
            <form id="propertyForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="title" class="block text-sm font-medium text-gray-700">Title:</label>
                    <input type="text" id="title" class="input-field" required />
                </div>
                <div class="form-group">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description:</label>
                    <textarea id="description" class="input-field" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="type" class="block text-sm font-medium text-gray-700">Type:</label>
                    <select id="type" class="input-field" onchange="toggleBedBathFields('submit')" required>
                        <option value="">Select Type</option>
                        <option value="Plot">Plot</option>
                        <option value="Bungalow">Bungalow</option>
                        <option value="Flat / Portion">Flat / Portion</option>
                        <option value="Shop">Shop</option>
                        <option value="Basement">Basement</option>
                        <option value="Office">Office</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Factory">Factory</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="purpose" class="block text-sm font-medium text-gray-700">Purpose:</label>
                    <select id="purpose" class="input-field" required>
                        <option value="">Select Purpose</option>
                        <option value="Sale">For Sale</option>
                        <option value="Rent">For Rent</option>
                    </select>
                </div>
                 <!-- Combined Location Field -->
                <div class="form-group md:col-span-2">
                    <label for="location" class="block text-sm font-medium text-gray-700">Location:</label>
                    <input type="text" id="location" class="input-field" placeholder="e.g., DHA PHASE, Block 1, Commercial Name" required />
                </div>
                <div class="form-group">
                    <label for="areaUnit" class="block text-sm font-medium text-gray-700">Area Unit:</label>
                    <select id="areaUnit" class="input-field" required>
                        <option value="">Select Unit</option>
                        <option value="Sq.Yards">Sq.Yards</option>
                        <option value="Sq.Ft">Sq.Ft</option>
                        <option value="Marla">Marla</option>
                        <option value="Kanal">Kanal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="areaValue" class="block text-sm font-medium text-gray-700">Area Value:</label>
                    <input type="number" id="areaValue" class="input-field" min="0" required />
                </div>
                <div class="form-group" id="bedrooms-field-submit">
                    <label for="bedrooms" class="block text-sm font-medium text-gray-700">Bedrooms:</label>
                    <input type="number" id="bedrooms" class="input-field" min="0" />
                </div>
                <div class="form-group" id="bathrooms-field-submit">
                    <label for="bathrooms" class="block text-sm font-medium text-gray-700">Bathrooms:</label>
                    <input type="number" id="bathrooms" class="input-field" min="0" />
                </div>
                <div class="form-group">
                    <label for="price" class="block text-sm font-medium text-gray-700">Price (PKR):</label>
                    <input type="number" id="price" class="input-field" min="0" required />
                </div>
                <div class="form-group">
                    <label for="agency" class="block text-sm font-medium text-gray-700">Agency Name:</label>
                    <input type="text" id="agency" class="input-field" />
                </div>
                <div class="form-group">
                    <label for="agent" class="block text-sm font-medium text-gray-700">Agent Name:</label>
                    <input type="text" id="agent" class="input-field" />
                </div>
                <div class="form-group">
                    <label for="contact" class="block text-sm font-medium text-gray-700">Contact Number:</label>
                    <input type="tel" id="contact" class="input-field" placeholder="e.g., 03XX-XXXXXXX" required />
                </div>
                <button type="submit" class="btn btn-primary md:col-span-2">Submit Property</button>
            </form>
            <p id="post-limit-message" class="text-red-500 mt-4 hidden"></p>
        </section>

        <!-- Archive Section -->
        <section id="archive-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Property Archive</h2>
            <button class="filter-toggle-button btn btn-secondary" onclick="toggleFilterVisibility('archive-filters')">Show/Hide Filters</button>
            <div id="archive-filters" class="filter-inputs-wrapper md:block">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <select id="filterPurposeArchive" class="input-field">
                        <option value="">All Purposes</option>
                        <option value="Sale">For Sale</option>
                        <option value="Rent">For Rent</option>
                    </select>
                    <select id="filterTypeArchive" class="input-field">
                        <option value="">All Types</option>
                        <option value="Plot">Plot</option>
                        <option value="Bungalow">Bungalow</option>
                        <option value="Flat / Portion">Flat / Portion</option>
                        <option value="Shop">Shop</option>
                        <option value="Basement">Basement</option>
                        <option value="Office">Office</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Factory">Factory</option>
                    </select>
                    <input type="text" id="filterLocationArchive" placeholder="Location (e.g., DHA PHASE, CLIFTON BLOCK)" class="input-field" />
                    <input type="date" id="filterDateArchive" class="input-field" />
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4" id="bedroom-filter-archive-container">
                    <input type="number" id="bedroomCountArchive" placeholder="Min Bedrooms" class="input-field flex-grow" min="0" />
                </div>
                <button type="button" class="btn btn-primary w-full md:w-auto mt-4" onclick="loadArchiveData()">Search Archive</button>
            </div>
            <div id="archivePropertiesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                <!-- Properties will be loaded here -->
            </div>
        </section>

        <!-- Magazine Section -->
        <section id="magazine-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Property Magazine</h2>
            <button class="filter-toggle-button btn btn-secondary" onclick="toggleFilterVisibility('magazine-filters')">Show/Hide Filters</button>
            <div id="magazine-filters" class="filter-inputs-wrapper md:block">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <select id="filterPurposeMagazine" class="input-field">
                        <option value="">All Purposes</option>
                        <option value="Sale">For Sale</option>
                        <option value="Rent">For Rent</option>
                    </select>
                    <select id="filterTypeMagazine" class="input-field">
                        <option value="">All Types</option>
                        <option value="Plot">Plot</option>
                        <option value="Bungalow">Bungalow</option>
                        <option value="Flat / Portion">Flat / Portion</option>
                        <option value="Shop">Shop</option>
                        <option value="Basement">Basement</option>
                        <option value="Office">Office</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Factory">Factory</option>
                    </select>
                    <input type="number" id="minPriceMagazine" placeholder="Min Price" class="input-field" min="0" />
                    <input type="number" id="maxPriceMagazine" placeholder="Max Price" class="input-field" min="0" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <input type="number" id="bedroomCountMagazine" placeholder="Min Bedrooms" class="input-field" min="0" />
                    <input type="number" id="minAreaMagazine" placeholder="Min Area" class="input-field" min="0" />
                    <input type="number" id="maxAreaMagazine" placeholder="Max Area" class="input-field" min="0" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="filterLocationMagazine" placeholder="Location (e.g., DHA PHASE, CLIFTON BLOCK)" class="input-field" />
                    <input type="date" id="filterDateMagazine" class="input-field" />
                    <input type="text" id="keywordMagazine" placeholder="Search by keyword (Title, Description)" class="input-field" />
                </div>
                <button type="button" class="btn btn-primary w-full md:w-auto mt-4" onclick="loadMagazineData()">Search Magazine</button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md mt-6">
                <table class="table-auto w-full">
                    <thead class="bg-blue-100">
                        <tr>
                            <th class="px-4 py-2">Title</th>
                            <th class="px-4 py-2">Type</th>
                            <th class="px-4 py-2">Purpose</th>
                            <th class="px-4 py-2">Area</th>
                            <th class="px-4 py-2">Price</th>
                            <th class="px-4 py-2">Location</th>
                            <th class="px-4 py-2">Agency</th>
                            <th class="px-4 py-2">Agent</th>
                            <th class="px-4 py-2">View</th>
                        </tr>
                    </thead>
                    <tbody id="magazinePropertiesContainer">
                        <!-- Properties will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sign Up Section -->
        <section id="signup-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Sign Up</h2>
            <form id="signupForm" class="max-w-md mx-auto">
                <div class="form-group">
                    <label for="signupEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="signupEmail" class="input-field" required />
                </div>
                <div class="form-group">
                    <label for="signupPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                    <input type="password" id="signupPassword" class="input-field" required minlength="6" placeholder="Min 6 characters" />
                </div>
                <div class="form-group">
                    <label for="signupConfirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password:</label>
                    <input type="password" id="signupConfirmPassword" class="input-field" required minlength="6" />
                </div>
                <button type="submit" class="btn btn-primary w-full">Sign Up</button>
                <p class="mt-4 text-center text-gray-600">Already have an account? <a href="#" class="text-blue-600 hover:underline" onclick="showPage('signin-section')">Sign In</a></p>
            </form>
        </section>

        <!-- Sign In Section -->
        <section id="signin-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Sign In</h2>
            <form id="signinForm" class="max-w-md mx-auto">
                <div class="form-group">
                    <label for="signinEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="signinEmail" class="input-field" required />
                </div>
                <div class="form-group">
                    <label for="signinPassword" class="block text-sm font-medium text-gray-700">Password:</label>
                    <input type="password" id="signinPassword" class="input-field" required />
                </div>
                <button type="submit" class="btn btn-primary w-full">Sign In</button>
                <p class="mt-4 text-center text-gray-600">
                    <a href="#" class="text-blue-600 hover:underline" onclick="showPage('forgot-password-section')">Forgot Password?</a>
                </p>
                <p class="mt-2 text-center text-gray-600">Don't have an account? <a href="#" class="text-blue-600 hover:underline" onclick="showPage('signup-section')">Sign Up</a></p>
            </form>
            <button class="btn btn-secondary w-full mt-4 max-w-md mx-auto block" onclick="showPage('admin-login-section')">Admin Login</button>
        </section>

        <!-- Admin Login Section (hidden by default, only accessible from Sign In page) -->
        <section id="admin-login-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Admin Login</h2>
            <form id="adminLoginForm" class="max-w-md mx-auto">
                <div class="form-group">
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700">Admin Email:</label>
                    <input type="email" id="adminEmail" class="input-field" required />
                </div>
                <div class="form-group">
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Admin Password:</label>
                    <input type="password" id="adminPassword" class="input-field" required />
                </div>
                <button type="submit" class="btn btn-primary w-full">Login as Admin</button>
            </form>
        </section>

        <!-- Forgot Password Section -->
        <section id="forgot-password-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Forgot Password</h2>
            <form id="forgotPasswordForm" class="max-w-md mx-auto">
                <div class="form-group">
                    <label for="forgotEmail" class="block text-sm font-medium text-gray-700">Enter your Email:</label>
                    <input type="email" id="forgotEmail" class="input-field" required />
                </div>
                <div class="form-group">
                    <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password:</label>
                    <input type="password" id="newPassword" class="input-field" required minlength="6" placeholder="Min 6 characters" />
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">Confirm New Password:</label>
                    <input type="password" id="confirmNewPassword" class="input-field" required minlength="6" />
                </div>
                <button type="submit" class="btn btn-primary w-full">Reset Password</button>
                <p class="mt-4 text-center text-gray-600"><a href="#" class="text-blue-600 hover:underline" onclick="showPage('signin-section')">Back to Sign In</a></p>
            </form>
        </section>

        <!-- Agent Dashboard Section -->
        <section id="agent-dashboard-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Agent Dashboard</h2>
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">Your Profile</h3>
                <p><strong>Email:</strong> <span id="agentEmailDisplay"></span></p>
                <p><strong>Role:</strong> <span id="agentRoleDisplay"></span></p>
                <p><strong>Post Limit:</strong> <span id="agentPostLimitDisplay"></span> posts per 30 days</p>
                <p><strong>Posts Made:</strong> <span id="agentPostsMadeDisplay"></span></p>
                <p><strong>Remaining Posts:</strong> <span id="agentRemainingPostsDisplay" class="font-bold"></span></p>

                <h4 class="text-lg font-semibold mt-4 mb-2">Update Profile</h4>
                <form id="updateProfileForm" class="max-w-md">
                    <div class="form-group">
                        <label for="updateEmail" class="block text-sm font-medium text-gray-700">New Email (optional):</label>
                        <input type="email" id="updateEmail" class="input-field" />
                    </div>
                    <div class="form-group">
                        <label for="updatePassword" class="block text-sm font-medium text-gray-700">New Password (optional):</label>
                        <input type="password" id="updatePassword" class="input-field" minlength="6" placeholder="Min 6 characters" />
                    </div>
                    <div class="form-group">
                        <label for="confirmUpdatePassword" class="block text-sm font-medium text-gray-700">Confirm New Password:</label>
                        <input type="password" id="confirmUpdatePassword" class="input-field" minlength="6" />
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>

                <h4 class="text-lg font-semibold mt-6 mb-2">Request Post Limit Increase</h4>
                <form id="limitRequestForm" class="max-w-md">
                    <div class="form-group">
                        <label for="requestedLimit" class="block text-sm font-medium text-gray-700">Request Limit:</label>
                        <select id="requestedLimit" class="input-field" required>
                            <option value="">Select an Option</option>
                            <option value="5">5 posts per 30 days (Default)</option>
                            <option value="10">10 posts per 30 days</option>
                            <option value="20">20 posts per 30 days</option>
                            <option value="30">30 posts per 30 days</option>
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button type="submit" class="btn btn-success flex-grow">Send Request to Admin</button>
                        <button type="button" class="btn bg-green-500 hover:bg-green-600 text-white flex-grow" onclick="sendLimitRequestViaWhatsApp()">WhatsApp Admin</button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        *An email will be sent to the admin, and a copy will be saved. For direct communication, you can also WhatsApp the admin at <a href="https://wa.me/923218248686" target="_blank" class="text-blue-600 hover:underline">03218248686</a>.
                    </p>
                </form>
            </div>

            <h3 class="text-xl font-semibold mb-2">Your Posted Properties</h3>
            <div id="agentPropertiesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Agent's properties will be loaded here -->
            </div>
        </section>

        <!-- Admin Dashboard Section -->
        <section id="admin-dashboard-section" class="page-section card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center">Admin Dashboard</h2>

            <div class="mb-8">
                <h3 class="text-xl font-semibold mb-2">Manage Users</h3>
                <div id="adminUsersContainer" class="overflow-x-auto rounded-lg shadow-md">
                    <table class="table-auto w-full">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="px-4 py-2">ID</th>
                                <th class="px-4 py-2">Email</th>
                                <th class="px-4 py-2">Role</th>
                                <th class="px-4 py-2">Post Limit</th>
                                <th class="px-4 py-2">Posts Made</th>
                                <th class="px-4 py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-2">Manage All Properties</h3>
                <div id="adminPropertiesContainer" class="overflow-x-auto rounded-lg shadow-md">
                    <table class="table-auto w-full">
                        <thead class="bg-blue-100">
                            <tr>
                                <th class="px-4 py-2">ID</th>
                                <th class="px-4 py-2">Title</th>
                                <th class="px-4 py-2">Type</th>
                                <th class="px-4 py-2">Purpose</th>
                                <th class="px-4 py-2">Location</th>
                                <th class="px-4 py-2">Agent ID</th>
                                <th class="px-4 py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminPropertiesTableBody">
                            <!-- All properties will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-600 mt-8 py-4 bg-blue-800 text-white rounded-lg shadow-md">
            <p>&copy; 2025 PROJECT BY NJK REAL ESTATE. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // ✅ Configuration: Replace with your deployed Apps Script Web App URL
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwvXQyS6cTVU0LNvVE1b2cRPsP4y8mAcbxdz9C9aXNOqCPgj9IxVagWfhjSD9d_ImWw/exec"; // PASTE YOUR DEPLOYED WEB APP URL HERE
        const ADMIN_WHATSAPP_NUMBER = "923218248686"; // Admin's WhatsApp number for limit increase requests

        // Initialize allPropertiesData as an empty array.
        // It will be populated dynamically from the backend.
        let allPropertiesData = [];
        let loggedInUser = null; // Stores logged in user data (ID, Email, Role, PostLimit, PostsMade)

        // ✅ Security Utility Function: Escape HTML to prevent XSS
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // ✅ UI Utility Functions
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
            // Close mobile menu if open when navigating to a new page
            const navUl = document.getElementById('main-nav')?.querySelector('ul'); // Added optional chaining
            if (navUl && navUl.classList.contains('active')) { // Check if navUl exists
                navUl.classList.remove('active');
            }
        }

        function showLoadingSpinner() {
            document.getElementById('loading-spinner').style.display = 'block';
        }

        function hideLoadingSpinner() {
            document.getElementById('loading-spinner').style.display = 'none';
        }

        function showModal(message, type = 'alert', onConfirm = null) {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            modalMessage.innerHTML = message; // Use innerHTML for rich content
            modalButtons.innerHTML = ''; // Clear previous buttons

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirm';
                confirmBtn.className = 'btn btn-danger mr-2';
                confirmBtn.onclick = () => {
                    closeModal();
                    if (onConfirm) onConfirm();
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = closeModal;
                modalButtons.appendChild(cancelBtn);
            } else { // 'alert' type
                // No "OK" button needed if cross button is sufficient
                // const okBtn = document.createElement('button');
                // okBtn.textContent = 'OK';
                // okBtn.className = 'btn btn-primary';
                // okBtn.onclick = closeModal;
                // modalButtons.appendChild(okBtn);
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        // ✅ Authentication and Session Management
        function loadUserSession() {
            const userJson = localStorage.getItem('loggedInUser');
            if (userJson) {
                loggedInUser = JSON.parse(userJson);
                updateNavigation();
                // If logged in, automatically show agent dashboard or admin dashboard
                if (loggedInUser.Role === 'admin') {
                    showPage('admin-dashboard-section');
                    loadAdminDashboard();
                } else {
                    showPage('agent-dashboard-section');
                    loadAgentDashboard();
                }
            } else {
                updateNavigation();
                showPage('recent-carousel-section'); // Default page if not logged in
            }
        }

        function saveUserSession(user) {
            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(user));
            updateNavigation();
        }

        function clearUserSession() {
            loggedInUser = null;
            localStorage.removeItem('loggedInUser');
            updateNavigation();
        }

        function updateNavigation() {
            const postPropertyNav = document.getElementById('post-property-nav');
            const agentDashboardNav = document.getElementById('agent-dashboard-nav');
            const adminDashboardNav = document.getElementById('admin-dashboard-nav');
            const signupNav = document.getElementById('signup-nav');
            const signinNav = document.getElementById('signin-nav');
            const logoutNav = document.getElementById('logout-nav');

            if (loggedInUser) {
                signupNav.classList.add('hidden');
                signinNav.classList.add('hidden');
                logoutNav.classList.remove('hidden');
                // Admin can also post properties
                if (loggedInUser.Role === 'agent' || loggedInUser.Role === 'admin') {
                    postPropertyNav.classList.remove('hidden');
                } else {
                    postPropertyNav.classList.add('hidden');
                }

                if (loggedInUser.Role === 'agent') {
                    agentDashboardNav.classList.remove('hidden');
                    adminDashboardNav.classList.add('hidden');
                } else if (loggedInUser.Role === 'admin') {
                    agentDashboardNav.classList.add('hidden');
                    adminDashboardNav.classList.remove('hidden');
                }
            } else {
                signupNav.classList.remove('hidden');
                signinNav.classList.remove('hidden');
                logoutNav.classList.add('hidden');
                postPropertyNav.classList.add('hidden');
                agentDashboardNav.classList.add('hidden');
                adminDashboardNav.classList.add('hidden');
            }
        }

        function logout() {
            clearUserSession();
            showModal('You have been logged out.', 'alert');
            showPage('recent-carousel-section');
        }

        function checkAuthAndShowPostForm() {
            if (loggedInUser && (loggedInUser.Role === 'agent' || loggedInUser.Role === 'admin')) {
                showPage('submit-post-section');
                updatePostLimitMessage();
            } else {
                showModal('Please sign in or sign up as an agent to post a property.', 'alert');
                showPage('signin-section');
            }
        }

        function updatePostLimitMessage() {
            const messageElement = document.getElementById('post-limit-message');
            if (loggedInUser) {
                const remaining = loggedInUser.PostLimit - loggedInUser.PostsMade;
                if (remaining <= 0 && loggedInUser.Role !== 'admin') {
                    messageElement.textContent = `You have reached your post limit of ${loggedInUser.PostLimit} posts per 30 days. Please request an increase from your dashboard.`;
                    messageElement.classList.remove('hidden');
                    document.getElementById('propertyForm').querySelector('button[type="submit"]').disabled = true;
                } else {
                    messageElement.textContent = `You have ${remaining} posts remaining out of ${loggedInUser.PostLimit} for the current 30-day cycle.`;
                    messageElement.classList.remove('hidden');
                    document.getElementById('propertyForm').querySelector('button[type="submit"]').disabled = false;
                }
            } else {
                messageElement.classList.add('hidden');
            }
        }

        // ✅ Fetch Data from Apps Script
        async function fetchData(method, params = {}) {
            showLoadingSpinner();
            const url = new URL(APPS_SCRIPT_WEB_APP_URL);
            url.searchParams.append('method', method); // Add custom method parameter

            // Append all params to URL search params for GET requests
            // For POST, params are sent in the body, but Apps Script also reads from e.parameter
            // so sending as query params for POST is also fine and simpler for Apps Script
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }

            try {
                const response = await fetch(url.toString(), {
                    method: 'POST', // Always use POST for Apps Script Web App for all operations
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // Required for e.parameter parsing
                    },
                    // body: new URLSearchParams(params).toString() // Can also send in body, but e.parameter handles query params too
                });
                const data = await response.json();
                hideLoadingSpinner();
                // ONLY show error if status is error AND message is not about dummy password refresh
                if (data.status === "error") {
                    // This condition prevents the "Invalid email or password" error from showing
                    // when it's a non-auth related operation that might trigger a benign error.
                    // Apps Script often sends this generic error for any internal issue.
                    if (data.message.includes("Invalid email or password") && (method === 'loginUser' || method === 'registerUser' || method === 'adminLogin' || method === 'forgotPassword')) {
                         // This is a real auth error, so show it.
                        showModal(`Error: ${data.message}`, 'alert');
                    } else if (!data.message.includes("Invalid email or password")) {
                        // Show other errors that are not the benign "Invalid email or password"
                        showModal(`Error: ${data.message}`, 'alert');
                    }
                    return null;
                }
                return data;
            } catch (error) {
                hideLoadingSpinner();
                showModal(`Network error: ${error.message}. Please check your internet connection or try again later.`, 'alert');
                console.error("Fetch error:", error);
                return null;
            }
        }

        async function fetchAllProperties() {
            const data = await fetchData('getAllProperties'); // Using getAllProperties method for consistency
            if (data && data.data) {
                allPropertiesData = data.data;
                allPropertiesData.forEach(p => {
                    // Ensure contact number always has a leading zero if it's a Pakistani number and missing
                    if (p.Contact && p.Contact.length === 10 && p.Contact.startsWith('3')) {
                        p.Contact = '0' + p.Contact;
                    }
                });
                loadRecentData(); // Load data initially for all sections
                loadArchiveData();
                loadMagazineData();
            } else {
                // If fetching fails or no data, ensure allPropertiesData is empty
                allPropertiesData = [];
                // Also clear the displayed properties in case of an error
                document.getElementById('recentPropertiesContainer').innerHTML = '<p class="text-center text-gray-500 md:col-span-3">No properties found.</p>';
                document.getElementById('archivePropertiesContainer').innerHTML = '<p class="text-center text-gray-500 md:col-span-3">No properties found.</p>';
                document.getElementById('magazinePropertiesContainer').innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">No records found.</td></tr>';
            }
        }

        // ✅ Render Property Cards (for Recent and Archive sections)
        function renderPropertyCards(properties, containerId, showActions = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous content

            if (properties.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 md:col-span-3">No properties found matching your criteria.</p>';
                return;
            }

            properties.forEach(property => {
                const card = document.createElement('div');
                card.className = 'card p-4 flex flex-col justify-between'; // Added flex-col and justify-between
                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold mb-2">${escapeHTML(property.Title)}</h3>
                        <p class="text-gray-700 mb-2">${escapeHTML(property.Description)}</p>
                        <p><strong>Type:</strong> ${escapeHTML(property.Type)}</p>
                        <p><strong>Purpose:</strong> ${escapeHTML(property.Purpose)}</p>
                        <p><strong>Location:</strong> ${escapeHTML(property.Location)}</p>
                        <p><strong>Area:</strong> ${escapeHTML(property.AreaValue)} ${escapeHTML(property.AreaUnit)}</p>
                        ${property.Bedrooms ? `<p><strong>Bedrooms:</strong> ${escapeHTML(property.Bedrooms)}</p>` : ''}
                        ${property.Bathrooms ? `<p><strong>Bathrooms:</strong> ${escapeHTML(property.Bathrooms)}</p>` : ''}
                        <p><strong>Price:</strong> PKR ${escapeHTML(property.Price.toLocaleString())}</p>
                        <p><strong>Agency:</strong> ${escapeHTML(property.Agency || 'N/A')}</p>
                        <p><strong>Agent:</strong> ${escapeHTML(property.Agent || 'N/A')}</p>
                        <p><strong>Contact:</strong> ${escapeHTML(property.Contact)}</p>
                        <p class="text-sm text-gray-500 mt-2">Posted: ${escapeHTML(new Date(property.Date).toLocaleDateString())}</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button class="btn btn-primary flex-grow" onclick='viewCommonCard(${JSON.stringify(property)})'>View Details</button>
                        ${showActions ? `
                            <button class="btn btn-secondary flex-grow" onclick="editProperty('${escapeHTML(property.ID)}', '${escapeHTML(containerId)}')">Edit</button>
                            <button class="btn btn-danger flex-grow" onclick="confirmDeleteProperty('${escapeHTML(property.ID)}', '${escapeHTML(containerId)}')">Delete</button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ✅ Filtering Logic
        function filterProperties(data, purposeId, typeId, locationId, dateId, bedroomId, minPriceId, maxPriceId, minAreaId, maxAreaId, keywordId) {
            let filteredData = [...data]; // Create a copy to avoid modifying original array

            const purpose = document.getElementById(purposeId)?.value;
            const type = document.getElementById(typeId)?.value;
            const locationFilterText = document.getElementById(locationId)?.value.toLowerCase(); // Renamed for clarity
            const date = document.getElementById(dateId)?.value;
            const minBedrooms = parseInt(document.getElementById(bedroomId)?.value);
            const minPrice = parseFloat(document.getElementById(minPriceId)?.value);
            const maxPrice = parseFloat(document.getElementById(maxPriceId)?.value);
            const minArea = parseFloat(document.getElementById(minAreaId)?.value);
            const maxArea = parseFloat(document.getElementById(maxAreaId)?.value);
            const keyword = document.getElementById(keywordId)?.value.toLowerCase();

            if (purpose) {
                filteredData = filteredData.filter(p => p.Purpose === purpose);
            }
            if (type) {
                filteredData = filteredData.filter(p => p.Type === type);
            }
            if (locationFilterText) {
                // Filter by Location field
                filteredData = filteredData.filter(p =>
                    p.Location.toLowerCase().includes(locationFilterText)
                );
            }
            if (date) {
                filteredData = filteredData.filter(p => {
                    const propertyDate = new Date(p.Date).toISOString().split('T')[0];
                    return propertyDate === date;
                });
            }
            if (!isNaN(minBedrooms) && minBedrooms > 0) {
                filteredData = filteredData.filter(p => parseInt(p.Bedrooms) >= minBedrooms);
            }
            if (!isNaN(minPrice)) {
                filteredData = filteredData.filter(p => parseFloat(p.Price) >= minPrice);
            }
            if (!isNaN(maxPrice)) {
                filteredData = filteredData.filter(p => parseFloat(p.Price) <= maxPrice);
            }
            if (!isNaN(minArea)) {
                filteredData = filteredData.filter(p => parseFloat(p.AreaValue) >= minArea);
            }
            if (!isNaN(maxArea)) {
                filteredData = filteredData.filter(p => parseFloat(p.AreaValue) <= maxArea);
            }
            if (keyword) {
                filteredData = filteredData.filter(p =>
                    p.Title.toLowerCase().includes(keyword) ||
                    p.Description.toLowerCase().includes(keyword) ||
                    p.Location.toLowerCase().includes(keyword) ||
                    p.Type.toLowerCase().includes(keyword) ||
                    p.Purpose.toLowerCase().includes(keyword)
                );
            }

            return filteredData;
        }

        function loadRecentData() {
            // Ensure bedroom filter visibility is updated before filtering
            toggleBedroomsFilter('carousel');
            const filtered = filterProperties(allPropertiesData, 'filterPurposeCarousel', 'filterTypeCarousel', 'filterLocationCarousel', 'filterDateCarousel', 'bedroomCountCarousel');
            renderPropertyCards(filtered, 'recentPropertiesContainer');
        }

        function loadArchiveData() {
            // Ensure bedroom filter visibility is updated before filtering
            toggleBedroomsFilter('archive');
            const filtered = filterProperties(allPropertiesData, 'filterPurposeArchive', 'filterTypeArchive', 'filterLocationArchive', 'filterDateArchive', 'bedroomCountArchive');
            renderPropertyCards(filtered, 'archivePropertiesContainer');
        }

        function loadMagazineData() {
            // Ensure bedroom filter visibility is updated before filtering
            toggleBedroomsFilter('magazine');
            const filtered = filterProperties(allPropertiesData, 'filterPurposeMagazine', 'filterTypeMagazine', 'filterLocationMagazine', 'filterDateMagazine', 'bedroomCountMagazine', 'minPriceMagazine', 'maxPriceMagazine', 'minAreaMagazine', 'maxAreaMagazine', 'keywordMagazine');
            renderMagazineTable(filtered, 'magazinePropertiesContainer');
        }

        // ✅ Toggle Bedrooms/Bathrooms fields visibility based on property type
        function toggleBedBathFields(formType) {
            const typeSelect = document.getElementById(formType === 'submit' ? 'type' : `filterType${formType.charAt(0).toUpperCase() + formType.slice(1)}`);
            const bedroomsField = document.getElementById(`bedrooms-field-${formType}`);
            const bathroomsField = document.getElementById(`bathrooms-field-${formType}`);

            const selectedType = typeSelect.value;
            const showFields = ['Bungalow', 'Flat / Portion'].includes(selectedType);

            if (bedroomsField) {
                bedroomsField.classList.toggle('hidden', !showFields);
                bedroomsField.querySelector('input').required = showFields;
            }
            if (bathroomsField) {
                bathroomsField.classList.toggle('hidden', !showFields);
                bathroomsField.querySelector('input').required = showFields;
            }
        }

        function toggleBedroomsFilter(section) {
            const typeSelect = document.getElementById(`filterType${section.charAt(0).toUpperCase() + section.slice(1)}`);
            const bedroomFilterContainer = document.getElementById(`bedroom-filter-${section}-container`);
            const selectedType = typeSelect.value;
            const showFilter = ['Bungalow', 'Flat / Portion'].includes(selectedType);

            if (bedroomFilterContainer) {
                bedroomFilterContainer.classList.toggle('hidden', !showFilter);
            }
            // No need to call loadData here, as it will be called by the search button click
        }

        // ✅ Property Submission (Create/Update)
        document.getElementById('propertyForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const submitButton = document.getElementById('propertyForm').querySelector('button[type="submit"]');
            submitButton.disabled = true; // Disable button to prevent double submission

            if (!loggedInUser) {
                showModal('You must be logged in to post a property.', 'alert');
                submitButton.disabled = false; // Re-enable button on error
                return;
            }

            // Admin can post without limit, agents are checked
            if (loggedInUser.Role !== 'admin' && loggedInUser.PostsMade >= loggedInUser.PostLimit) {
                 showModal('You have reached your post limit. Please request an increase from your dashboard.', 'alert');
                 submitButton.disabled = false; // Re-enable button on error
                 return;
            }

            const form = event.target;
            const propertyData = {
                Title: form.title.value,
                Description: form.description.value,
                Type: form.type.value,
                Purpose: form.purpose.value,
                Location: form.location.value, // Now a single combined field
                AreaUnit: form.areaUnit.value,
                AreaValue: form.areaValue.value,
                Bedrooms: form.bedrooms.value,
                Bathrooms: form.bathrooms.value,
                Price: form.price.value,
                Agency: form.agency.value,
                Agent: form.agent.value,
                Contact: form.contact.value,
                UserID: loggedInUser.ID // Attach current user's ID
            };

            // If editing, add the ID
            const propertyId = form.dataset.editingId;
            let result;
            try {
                if (propertyId) {
                    propertyData.ID = propertyId;
                    result = await fetchData('updateProperty', propertyData);
                } else {
                    result = await fetchData('createProperty', propertyData);
                }

                if (result && result.status === "success") {
                    showModal(result.message, 'alert');
                    form.reset();
                    delete form.dataset.editingId; // Clear editing state
                    submitButton.textContent = 'Submit Property';
                    await fetchAllProperties(); // Re-fetch all data to update all sections

                    // Update loggedInUser's postsMade count locally if it was a new creation for an agent
                    if (!propertyId && loggedInUser.Role === 'agent') {
                        loggedInUser.PostsMade = (loggedInUser.PostsMade || 0) + 1;
                        saveUserSession(loggedInUser); // Update local session with new post count
                    }
                    loadAgentDashboard(); // Reload agent dashboard to reflect changes
                    updatePostLimitMessage(); // Update message for post limit
                    showPage('recent-carousel-section'); // Go back to home after post/update
                }
            } finally {
                submitButton.disabled = false; // Always re-enable button
            }
        });

        // Function to populate form for editing
        async function editProperty(id, containerId) {
            const propertyToEdit = allPropertiesData.find(p => p.ID === id);
            if (!propertyToEdit) {
                showModal('Property not found for editing.', 'alert');
                return;
            }

            // Check if the current user is the owner or admin
            if (loggedInUser.ID !== propertyToEdit.UserID && loggedInUser.Role !== 'admin') {
                showModal('You are not authorized to edit this property.', 'alert');
                return;
            }

            showPage('submit-post-section');
            const form = document.getElementById('propertyForm');
            form.dataset.editingId = id; // Store ID for update operation

            // Populate form fields
            form.title.value = propertyToEdit.Title;
            form.description.value = propertyToEdit.Description;
            form.type.value = propertyToEdit.Type;
            form.purpose.value = propertyToEdit.Purpose;
            form.location.value = propertyToEdit.Location; // Populate combined field
            form.areaUnit.value = propertyToEdit.AreaUnit;
            form.areaValue.value = propertyToEdit.AreaValue;
            form.bedrooms.value = propertyToEdit.Bedrooms;
            form.bathrooms.value = propertyToEdit.Bathrooms;
            form.price.value = propertyToEdit.Price;
            form.agency.value = propertyToEdit.Agency;
            form.agent.value = propertyToEdit.Agent;
            form.contact.value = propertyToEdit.Contact;

            toggleBedBathFields('submit'); // Ensure bed/bath fields are correctly shown/hidden
            form.querySelector('button[type="submit"]').textContent = 'Update Property';
        }

        // Function to confirm and delete property
        function confirmDeleteProperty(id, containerId) {
            showModal('Are you sure you want to delete this property?', 'confirm', async () => {
                const result = await fetchData('deleteProperty', { ID: id, UserID: loggedInUser.ID });
                if (result && result.status === "success") {
                    showModal(result.message, 'alert');
                    await fetchAllProperties(); // Re-fetch all data
                    // No change to PostsMade for delete, but refresh dashboard
                    if (loggedInUser.Role === 'agent') {
                        loadAgentDashboard();
                    } else if (loggedInUser.Role === 'admin') {
                        loadAdminDashboard();
                    }
                }
            });
        }

        // ✅ User Authentication Forms
        document.getElementById('signupForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (password !== confirmPassword) {
                showModal('Passwords do not match.', 'alert');
                return;
            }
            if (password.length < 6) {
                showModal('Password must be at least 6 characters long.', 'alert');
                return;
            }

            const result = await fetchData('registerUser', { Email: email, Password: password });
            if (result && result.status === "success") {
                showModal(result.message, 'alert');
                document.getElementById('signupForm').reset();
                showPage('signin-section');
            }
        });

        document.getElementById('signinForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;

            const result = await fetchData('loginUser', { Email: email, Password: password });
            if (result && result.status === "success") {
                saveUserSession(result.user);
                showModal(result.message, 'alert');
                document.getElementById('signinForm').reset();
                if (loggedInUser.Role === 'admin') {
                    showPage('admin-dashboard-section');
                    loadAdminDashboard();
                } else {
                    showPage('agent-dashboard-section');
                    loadAgentDashboard();
                }
            }
        });

        document.getElementById('adminLoginForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            const result = await fetchData('adminLogin', { Email: email, Password: password });
            if (result && result.status === "success") {
                saveUserSession(result.user);
                showModal(result.message, 'alert');
                document.getElementById('adminLoginForm').reset();
                showPage('admin-dashboard-section');
                loadAdminDashboard();
            }
        });

        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                showModal('New passwords do not match.', 'alert');
                return;
            }
            if (newPassword.length < 6) {
                showModal('New password must be at least 6 characters long.', 'alert');
                return;
            }

            const result = await fetchData('forgotPassword', { Email: email, NewPassword: newPassword });
            if (result && result.status === "success") {
                showModal(result.message, 'alert');
                document.getElementById('forgotPasswordForm').reset();
                showPage('signin-section');
            }
        });

        // ✅ Agent Dashboard Logic
        async function loadAgentDashboard() {
            if (!loggedInUser || loggedInUser.Role !== 'agent') {
                showModal('You must be logged in as an agent to view this page.', 'alert');
                showPage('signin-section');
                return;
            }

            // Display profile info
            document.getElementById('agentEmailDisplay').textContent = escapeHTML(loggedInUser.Email);
            document.getElementById('agentRoleDisplay').textContent = escapeHTML(loggedInUser.Role.toUpperCase());
            document.getElementById('agentPostLimitDisplay').textContent = escapeHTML(loggedInUser.PostLimit.toString());
            document.getElementById('agentPostsMadeDisplay').textContent = escapeHTML(loggedInUser.PostsMade.toString());
            document.getElementById('agentRemainingPostsDisplay').textContent = escapeHTML((loggedInUser.PostLimit - loggedInUser.PostsMade).toString());

            // Load agent's properties
            const data = await fetchData('getAgentPosts', { UserID: loggedInUser.ID });
            if (data && data.data) {
                renderPropertyCards(data.data, 'agentPropertiesContainer', true); // Show edit/delete actions
            } else {
                document.getElementById('agentPropertiesContainer').innerHTML = '<p class="text-center text-gray-500 md:col-span-3">No properties posted yet.</p>';
            }
        }

        // Update Profile Form
        document.getElementById('updateProfileForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const newEmail = document.getElementById('updateEmail').value;
            const newPassword = document.getElementById('updatePassword').value;
            const confirmNewPassword = document.getElementById('confirmUpdatePassword').value;

            if (newPassword && newPassword !== confirmNewPassword) {
                showModal('New passwords do not match.', 'alert');
                return;
            }
            if (newPassword && newPassword.length < 6) {
                showModal('New password must be at least 6 characters long.', 'alert');
                return;
            }

            const params = { UserID: loggedInUser.ID };
            if (newEmail) params.Email = newEmail;
            if (newPassword) params.NewPassword = newPassword;

            const result = await fetchData('updateUserProfile', params);
            if (result && result.status === "success") {
                showModal(result.message, 'alert');
                // Update local session with new data
                if (result.user) {
                    saveUserSession(result.user);
                }
                document.getElementById('updateProfileForm').reset();
                loadAgentDashboard(); // Reload dashboard to show updated info
            }
        });

        // Limit Request Form
        document.getElementById('limitRequestForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const requestedLimit = document.getElementById('requestedLimit').value;

            if (!requestedLimit) {
                showModal('Please select a limit to request.', 'alert');
                return;
            }

            const result = await fetchData('saveLimitIncreaseRequest', {
                UserID: loggedInUser.ID,
                UserEmail: loggedInUser.Email,
                RequestedLimit: requestedLimit
            });

            if (result && result.status === "success") {
                showModal(result.message, 'alert');
                document.getElementById('limitRequestForm').reset();
            }
        });

        // Function to send limit increase request via WhatsApp
        function sendLimitRequestViaWhatsApp() {
            if (!loggedInUser) {
                showModal('Please sign in to request a limit increase.', 'alert');
                return;
            }

            const requestedLimit = document.getElementById('requestedLimit').value;
            if (!requestedLimit) {
                showModal('Please select a limit to request before sending via WhatsApp.', 'alert');
                return;
            }

            const message = encodeURIComponent(`Post Limit Increase Request:\n\nAgent Email: ${loggedInUser.Email}\nAgent ID: ${loggedInUser.ID}\nRequested Limit: ${requestedLimit} posts per 30 days.`);
            const whatsappUrl = `https://wa.me/${ADMIN_WHATSAPP_NUMBER}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }


        // ✅ Admin Dashboard Logic
        async function loadAdminDashboard() {
            if (!loggedInUser || loggedInUser.Role !== 'admin') {
                showModal('You must be logged in as an admin to view this page.', 'alert');
                showPage('signin-section');
                return;
            }

            // Load all users
            const usersData = await fetchData('getAllUsers');
            if (usersData && usersData.data) {
                renderAdminUsersTable(usersData.data);
            } else {
                document.getElementById('adminUsersTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">No users found.</td></tr>';
            }

            // Load all properties
            const propertiesData = await fetchData('getAllProperties');
            if (propertiesData && propertiesData.data) {
                renderAdminPropertiesTable(propertiesData.data);
            } else {
                document.getElementById('adminPropertiesTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No properties found.</td></tr>';
            }
        }

        function renderAdminUsersTable(users) {
            const tableBody = document.getElementById('adminUsersTableBody');
            tableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${escapeHTML(user.ID)}</td>
                    <td class="px-4 py-2">${escapeHTML(user.Email)}</td>
                    <td class="px-4 py-2">${escapeHTML(user.Role)}</td>
                    <td class="px-4 py-2">${escapeHTML(user.PostLimit.toString())}</td>
                    <td class="px-4 py-2">${escapeHTML(user.PostsMade.toString())}</td>
                    <td class="px-4 py-2">
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-primary btn-sm" onclick="updateUserLimit('${escapeHTML(user.ID)}', 10)">10</button>
                            <button class="btn btn-primary btn-sm" onclick="updateUserLimit('${escapeHTML(user.ID)}', 20)">20</button>
                            <button class="btn btn-primary btn-sm" onclick="updateUserLimit('${escapeHTML(user.ID)}', 30)">30</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteUser('${escapeHTML(user.ID)}')">Delete</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function updateUserLimit(userId, limit) {
            const result = await fetchData('updateUserPostLimit', { TargetUserID: userId, NewLimit: limit });
            if (result && result.status === "success") {
                showModal(result.message, 'alert');
                loadAdminDashboard(); // Reload admin dashboard to show updated limits
            }
        }

        function confirmDeleteUser(userId) {
            showModal(`Are you sure you want to delete user ${escapeHTML(userId)} and all their properties?`, 'confirm', async () => {
                const result = await fetchData('deleteUser', { UserID: userId });
                if (result && result.status === "success") {
                    showModal(result.message, 'alert');
                    loadAdminDashboard(); // Reload admin dashboard
                }
            });
        }

        function renderAdminPropertiesTable(properties) {
            const tableBody = document.getElementById('adminPropertiesTableBody');
            tableBody.innerHTML = '';
            properties.forEach(property => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${escapeHTML(property.ID)}</td>
                    <td class="px-4 py-2">${escapeHTML(property.Title)}</td>
                    <td class="px-4 py-2">${escapeHTML(property.Type)}</td>
                    <td class="px-4 py-2">${escapeHTML(property.Purpose)}</td>
                    <td class="px-4 py-2">${escapeHTML(property.Location)}</td>
                    <td class="px-4 py-2">${escapeHTML(property.UserID || 'N/A')}</td>
                    <td class="px-4 py-2">
                        <div class="flex flex-wrap gap-2">
                            <button class="btn btn-secondary btn-sm" onclick="editProperty('${escapeHTML(property.ID)}', 'adminPropertiesContainer')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDeleteProperty('${escapeHTML(property.ID)}', 'adminPropertiesContainer')">Delete</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ✅ Magazine Table Specific Rendering
        function renderMagazineTable(properties, containerId) {
            const tbody = document.getElementById(containerId);
            tbody.innerHTML = ""; // Clear previous content

            if (properties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">No records found matching filters.</td></tr>';
                return;
            }

            properties.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-4 py-2">${escapeHTML(item.Title)}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Type)}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Purpose)}</td>
                    <td class="px-4 py-2">${escapeHTML(item.AreaValue || 'N/A')} ${escapeHTML(item.AreaUnit || '')}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Price)}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Location)}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Agency || 'N/A')}</td>
                    <td class="px-4 py-2">${escapeHTML(item.Agent || 'N/A')}</td>
                    <td class="px-4 py-2"><button class="btn btn-sm btn-primary" onclick='viewCommonCard(${JSON.stringify(item)})'>View</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ✅ Common View Card (for all sections)
        function viewCommonCard(post) {
            const rawContact = post.Contact;
            const cleanedPhone = rawContact.toString().replace(/[^0-9]/g, "");
            let internationalPhone = cleanedPhone;

            // Heuristic for Pakistani numbers: if starts with 03, convert to 923
            if (cleanedPhone.startsWith('03')) {
                internationalPhone = '92' + cleanedPhone.substring(1);
            } else if (cleanedPhone.startsWith('+923')) {
                internationalPhone = cleanedPhone.substring(1); // Remove '+'
            }

            const message = encodeURIComponent(`I am interested in your property: ${post.Title} located in ${post.Location}. Price: PKR ${post.Price.toLocaleString()}. Please share more details.`);
            const whatsappButtonHTML = `
                <a href="https://wa.me/${escapeHTML(internationalPhone)}?text=${message}" target="_blank"
                   class="btn bg-green-500 hover:bg-green-600 text-white w-full text-sm py-2 px-3">
                   WhatsApp: ${escapeHTML(rawContact)}
                </a>
            `;

            let bedroomInfoHTML = '';
            let bathroomInfoHTML = '';
            if (post.Type === 'Bungalow' || post.Type === 'Flat / Portion') {
                bedroomInfoHTML = `<p><strong>Bedrooms:</strong> ${escapeHTML(post.Bedrooms || 'N/A')}</p>`;
                bathroomInfoHTML = `<p><strong>Bathrooms:</strong> ${escapeHTML(post.Bathrooms || 'N/A')}</p>`;
            }

            const modalContentHTML = `
                <h4 class="text-2xl font-bold">${escapeHTML(post.Title)}</h4>
                <p class="text-gray-700"><strong>Description:</strong> ${escapeHTML(post.Description)}</p>
                <p><strong>Type:</strong> ${escapeHTML(post.Type)}</p>
                <p><strong>Purpose:</strong> ${escapeHTML(post.Purpose)}</p>
                <p><strong>Location:</strong> ${escapeHTML(post.Location)}</p>
                <p><strong>Area:</strong> ${escapeHTML(post.AreaValue)} ${escapeHTML(post.AreaUnit)}</p>
                ${bedroomInfoHTML}
                ${bathroomInfoHTML}
                <p><strong>Price:</strong> PKR ${escapeHTML(post.Price.toLocaleString())}</p>
                <p><strong>Agency:</strong> ${escapeHTML(post.Agency || 'N/A')}</p>
                <p><strong>Agent:</strong> ${escapeHTML(post.Agent || 'N/A')}</p>
                ${whatsappButtonHTML}
                <p class="text-sm text-gray-500 mt-2">Posted: ${escapeHTML(new Date(post.Date).toLocaleDateString())}</p>
            `;
            showModal(modalContentHTML, 'alert');
            document.getElementById('modal-buttons').innerHTML = ''; // Clear default buttons, no "OK" or "Close" button needed explicitly
        }

        // Function to toggle mobile navigation menu
        function toggleMobileMenu() {
            const navUl = document.getElementById('main-nav').querySelector('ul');
            navUl.classList.toggle('active');
        }

        // Function to toggle filter visibility for a given section
        function toggleFilterVisibility(filterContainerId) {
            const filterContainer = document.getElementById(filterContainerId);
            if (filterContainer) {
                filterContainer.classList.toggle('active');
            }
        }

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Replace "Flat" with "Flat / Portion" in all relevant select options
            document.querySelectorAll('option[value="Flat"]').forEach(option => {
                option.value = "Flat / Portion";
                option.textContent = "Flat / Portion";
            });

            await fetchAllProperties(); // Fetch all data first
            loadUserSession(); // Check for logged in user and update UI
            toggleBedBathFields('submit'); // Initialize the submit form's bed/bath visibility

            // Initial calls to toggle bedroom filter visibility, without triggering data load
            // These are now handled by the explicit search button clicks
            document.getElementById('filterTypeArchive').addEventListener('change', () => toggleBedroomsFilter('archive'));
            document.getElementById('filterTypeCarousel').addEventListener('change', () => toggleBedroomsFilter('carousel'));
            document.getElementById('filterTypeMagazine').addEventListener('change', () => toggleBedroomsFilter('magazine'));

            // Initial toggle for visibility based on default selected type
            toggleBedroomsFilter('archive');
            toggleBedroomsFilter('carousel');
            toggleBedroomsFilter('magazine');
        });

    </script>
</body>
</html>
